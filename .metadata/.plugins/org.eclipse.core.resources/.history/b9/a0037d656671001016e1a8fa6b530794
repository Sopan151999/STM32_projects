/*
 * Hdl_CAN.c
 *
 *  Created on: Aug 5, 2025
 *      Author: sopan
 */


#include "Hdl_CAN.h"

// Global variables
CAN_TxHeaderTypeDef TxHeader;
CAN_RxHeaderTypeDef RxHeader;
uint8_t TxData[8];
uint8_t RxData[8];
uint32_t TxMailbox;
volatile uint8_t CAN_MessageReceived = 0;

extern CAN_HandleTypeDef hcan;

// === CAN Initialization ===
void CAN_Init(void)
{
    HAL_CAN_Start(&hcan);
    HAL_CAN_ActivateNotification(&hcan, CAN_IT_RX_FIFO1_MSG_PENDING);
    CAN_ConfigFilter();
}

// === CAN Filter Configuration ===
void CAN_ConfigFilter(void)
{
    CAN_FilterTypeDef filter;

    filter.FilterActivation = CAN_FILTER_ENABLE;
    filter.FilterBank = 10;
    filter.FilterFIFOAssignment = CAN_FILTER_FIFO1;
    filter.FilterIdHigh = 0x0000;
    filter.FilterIdLow = 0x0000;
    filter.FilterMaskIdHigh = 0x0000;
    filter.FilterMaskIdLow = 0x0000;
    filter.FilterMode = CAN_FILTERMODE_IDMASK;
    filter.FilterScale = CAN_FILTERSCALE_32BIT;
    filter.SlaveStartFilterBank = 0;

    HAL_CAN_ConfigFilter(&hcan, &filter);
}

// === CAN Send Function ===
HAL_StatusTypeDef CAN_Send(uint16_t StdID, uint8_t* data, uint8_t len)
{
    TxHeader.StdId = StdID;
    TxHeader.IDE = CAN_ID_STD;
    TxHeader.RTR = CAN_RTR_DATA;
    TxHeader.DLC = len;

    return HAL_CAN_AddTxMessage(&hcan, &TxHeader, data, &TxMailbox);
}

// === CAN RX Callback ===
void HAL_CAN_RxFifo1MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
    HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO1, &RxHeader, RxData);
    CAN_MessageReceived = 1;  // Flag set for main loop
}
